---
title: "Obtaining weather data from rwunderground API"
author: "Miao Cai"
date: "`r Sys.Date()`"
header-includes:
  - \usepackage{bm}
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{array}
  - \usepackage{multirow}
  - \usepackage[table]{xcolor}
  - \usepackage{wrapfig}
  - \usepackage{float}
  - \usepackage{colortbl, soul}
  - \usepackage{pdflscape}
  - \usepackage{tabu}
  - \usepackage{threeparttable}
  - \usepackage{threeparttablex}
  - \usepackage[normalem]{ulem}
  - \usepackage{makecell}
  - \usepackage{url}
  - \usepackage{eso-pic,graphicx,transparent}
  - \usepackage{numprint}
  - \floatplacement{figure}{H}
output: 
  bookdown::pdf_document2:
    includes:
      in_header: header.tex 
    toc: false
    number_sections: true
    fig_caption: true
urlcolor: blue
linkcolor: blue
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```


# Applying for API key 

- Source: (https://www.wunderground.com/weather/api/?MR=1)
- Github: (https://github.com/ALShum/rwunderground)

To improve our services and enhance our relationship with our users, **we will no longer provide free weather API keys as part of our program**. If you have been directed to download our Weather Underground free API key by a third party provider, please contact your vendor for resolution.

# Data sources in `wunderground`

- **Data Core** – This data package includes many of the most essential weather APIs, ranging from current conditions and forecasts, radar and satellite data, including imagery for current conditions and forecasts.
- **Enhanced Current Conditions** – This package includes one of the highest-resolution weather observation networks that is available in the field based on over 200,000 personal weather stations in addition to traditional sources. 
- **Enhanced Forecast** – The Weather Company's forecast engine includes leading-edge ensemble model forecasting, 200 meteorologists and related scientists, The Weather Company's network of observations, and radar and satellite assimilation and modelling capabilities.
- **Severe Weather** – This data package includes forecasted, real-time, and trailing estimates of severe weather data, protecting a company's assets by staying one step ahead of adverse weather conditions, such as hail, lightning, severe wind, and tornadoes. 
- **Lifestyle Indices** – This set of lifestyle indices helps organizations use weather events to better serve their customers, including health indices such as air quality, pollen, flu outbreak, aches and pains, breathing, dry skin, and more.
- [**\hl{Historical Weather Data}**](https://business.weather.com/resource/history-on-demand-data-package-brochure) - Provides businesses with historical weather observations to help better understand how weather has impacted critical business processes in the past, allowing them to anticipate the influence that similar weather events may have in the future. In this package we offer access to hourly values for surface temperature, wind speed and direction, relative humidity, atmospheric pressure, and dew point. The data covers a 35 km worldwide grid and traces back to July of 2011 (Figure \@ref(fig:History)).
- **Seasonal and Subseasonal Forecast** – Provides a comprehensive view of the anticipated temperature and precipitation patterns for the 3- to 5-weeks, 1- to 4-months, and now 5- to 7-months.
- [**\hl{Traffic Data}**](https://business.weather.com/resource/ground-transportation-traffic-services-brochure) - Traffic, road, and incident data from more than 300 million sources that cover more than 8 million kilometers of roads in 50 countriesb (Figure \@ref(fig:Transportation)). 

```{r intr, eval=FALSE}
rwunderground::set_api_key("YOUR KEY")
```




# Other options

- [DarkSky](https://darksky.net/dev/docs/libraries). It has APIs supported by both [Python](https://github.com/bitpixdigital/forecastiopy3) and [R](https://github.com/hrbrmstr/darksky)
- [Aeris](https://www.aerisweather.com/support/docs/api/getting-started/). It has API supported by [Python](https://www.aerisweather.com/support/docs/api/getting-started/) only.
- [WorldWeatherOnline](https://developer.worldweatheronline.com/api/). Our historical weather API provides hourly past weather for worldwide locations since July 2008. It would be ideal for those with a focus on outdoor activities. Holiday goers and general fans of the outdoors will be interested in previous weather conditions at respective times of the year if they are set to visit that location in the future. API supported by JSON only.
- [OpenWeatherMap](https://openweathermap.org/history#geo). API only supported by JSON only.
- [Yahoo](https://developer.yahoo.com/weather/?guccounter=1). API supported by JSON only.
- [National Weather Service](https://www.weather.gov/help-past-weather)
- [NOAA](https://github.com/ropensci/rnoaa)

\newpage

```{r History, fig.cap="History of weather  brochure", fig.pos= "h"}
knitr::include_graphics("..\\weather API\\History.pdf")
```

```{r Transportation, fig.cap = "History of transportation brochure", fig.pos= "h"}
knitr::include_graphics("..\\weather API\\Transportation.pdf")
```



```{r excel, eval=F}
#devtools::install_github("MichaelChirico/readxl@date_fmts")
gps = readxl::read_excel("./weather API/Data for weather6_18.xlsx", sheet = "GPS")
save(gps, file = "./weather API/gps.Rdata")

set.seed(666)
gps_sample = gps[sample(1:nrow(gps), 800),]
save(gps_sample, file = "./weather API/gps_sample.Rdata")
```

# Darksky API

According to Mohammad's table, sheet 3 (all combinations of longitude, latitude and time), the total cost will be 112866 * 0.0001 = 11.2866 USD.

I randomly sampled 800 observations from that table. Then I obtained weather data from the darksky API. It took 162 seconds (2 minutes and 40 seconds) to get weather data from these 800 observations. If this time is scalable, then it will take 6.35 hours to get weather data for the whole table.

The weather data provided by darksky API includes 3 parts: 

- hourly (see Table \@ref(tab:t1)). 24 hourly observations for each 15 weather variables in that day.
- daily (see Table \@ref(tab:t2)). 1 observations for each 34 weather variables in that day.
- currently (see Table \@ref(tab:t3)). 1 observations for each 15 weather variables at that specific time point.

With regard to the demo data (800 randomly sampled observations), the number of missing values for each time specific column (part 3 of darksky API) is shown in Table \@ref(tab:missingpat).

```{r darksky, eval=F}
# devtools::install_github("hrbrmstr/darksky")
load("./weather API/gps_sample.Rdata")

library(darksky)
library(tidyverse)

Sys.setenv(DARKSKY_API_KEY = "9f219edf4689a0f26a83aa4d9a46f25a")

t = get_forecast_for(38.642105, -90.244440, Sys.time())

add_var = function(dat){
  dat[,c("time", 'summary', 'icon', 'precipIntensity', 'precipProbability', 'temperature', 'apparentTemperature', 'dewPoint', 'humidity', 'pressure', 'windSpeed', 'windGust', 'windBearing', 'cloudCover', 'visibility')] = NA
  return(dat)
}

gps_sample = add_var(gps_sample)

start = Sys.time()
for(i in 1:nrow(gps_sample)){
  t = get_forecast_for(gps_sample$from_lat[i], gps_sample$from_lon[i], gps_sample$beg_time[i])
  gps_sample$time[i] = ifelse(is.null(t[[3]]$time), NA, t[[3]]$time)
  gps_sample$summary[i] = ifelse(is.null(t[[3]]$summary), NA, t[[3]]$summary)
  gps_sample$icon[i] = ifelse(is.null(t[[3]]$icon), NA, t[[3]]$icon)
  gps_sample$precipIntensity[i] = ifelse(is.null(t[[3]]$precipIntensity), NA, t[[3]]$precipIntensity)
  gps_sample$precipProbability[i] = ifelse(is.null(t[[3]]$precipProbability), NA, t[[3]]$precipProbability)
  gps_sample$temperature[i] = ifelse(is.null(t[[3]]$temperature), NA, t[[3]]$temperature)
  gps_sample$apparentTemperature[i] = ifelse(is.null(t[[3]]$apparentTemperature), NA, t[[3]]$apparentTemperature)
  gps_sample$dewPoint[i] = ifelse(is.null(t[[3]]$dewPoint), NA, t[[3]]$dewPoint)
  gps_sample$humidity[i] = ifelse(is.null(t[[3]]$humidity), NA, t[[3]]$humidity)
  gps_sample$pressure[i] = ifelse(is.null(t[[3]]$pressure), NA, t[[3]]$pressure)
  gps_sample$windSpeed[i] = ifelse(is.null(t[[3]]$windSpeed), NA, t[[3]]$windSpeed)
  gps_sample$windGust[i] = ifelse(is.null(t[[3]]$windGust), NA, t[[3]]$windGust)
  gps_sample$windBearing[i] = ifelse(is.null(t[[3]]$windBearing), NA, t[[3]]$windBearing)
  gps_sample$cloudCover[i] = ifelse(is.null(t[[3]]$cloudCover), NA, t[[3]]$cloudCover)
  gps_sample$visibility[i] = ifelse(is.null(t[[3]]$visibility), NA, t[[3]]$visibility)
}

Sys.time() - start

gps_sample1 = gps_sample
save(gps_sample1, file = "./weather API/gps_sample1.Rdata")
save(t, file = "./weather API/t.Rdata")
```



\newpage
\blandscape
```{r t1, message=F, warning=F}
load("./t.Rdata")

require(magrittr)

knitr::kable(t[[1]], format = "latex",
             longtable = FALSE,
             booktabs = TRUE,
             caption = "Weather data from dark sky API part 1: hourly", 
             digits = 2, 
             linesep = "") %>% 
  kableExtra::kable_styling(font_size = 8,
                            position = "center",
                            latex_options = c("hold_position", "scale_down"))
```
\elandscape

```{r t2}
table2 = as.data.frame(t(t[[2]]))
table2$variable = row.names(table2)
row.names(table2) = NULL
table2 = table2[,c(2, 1)]

knitr::kable(table2, format = "latex",
             longtable = FALSE,
             booktabs = TRUE,
             caption = "Weather data from dark sky API part 2: daily", 
             digits = 2, 
             linesep = "") %>% 
  kableExtra::kable_styling(font_size = 8,
                            position = "center",
                            latex_options = c("hold_position"))
```


```{r t3}
table3 = as.data.frame(t(t[[2]]))
table3$variable = row.names(table3)
row.names(table3) = NULL
table3 = table3[,c(2, 1)]

knitr::kable(table3, format = "latex",
             longtable = FALSE,
             booktabs = TRUE,
             caption = "Weather data from dark sky API part 3: currently", 
             digits = 2, 
             linesep = "") %>% 
  kableExtra::kable_styling(font_size = 8,
                            position = "center",
                            latex_options = c("hold_position"))
```


\newpage

```{r missingpat}
load("./gps_sample1.Rdata")
mis = gps_sample1[, which(names(gps_sample1) == "summary"):ncol(gps_sample1)]
missing_num = sapply(mis, function(y) sum(length(which(is.na(y)))))

missing_num = as.data.frame(missing_num)
missing_num$variable = row.names(missing_num)
row.names(missing_num) = NULL
missing_num = missing_num[,c(2, 1)]

knitr::kable(missing_num, format = "latex",
             longtable = FALSE,
             booktabs = TRUE,
             caption = "Missing numbers of weather data for 800 random sampled observations", 
             digits = 2, 
             linesep = "") %>% 
  kableExtra::kable_styling(font_size = 8,
                            position = "center",
                            latex_options = c("hold_position"))
```













































































































































































































































































